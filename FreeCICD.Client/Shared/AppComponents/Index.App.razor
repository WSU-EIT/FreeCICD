@implements IDisposable
@using Humanizer
@using System.Linq
@using System.Text.Json
@using System.Text.Json.Serialization
@inject BlazorDataModel Model

@if(Model.Loaded && Model.LoggedIn && Model.View == _pageName) {
    if(Model.Tenant.TenantSettings.LogoIncludedOnHomePage && !String.IsNullOrWhiteSpace(LogoUrl)) {
        <div class="home-page-logo-container">
            <img src="@LogoUrl" class="logo-homepage" />
        </div>
    }

    if(_loading) {
        <LoadingMessage />
    } else {
        <h1 class="page-title">
            @if(!String.IsNullOrWhiteSpace(Model.Tenant.TenantSettings.AppIcon)) {
                <i>@((MarkupString)Model.Tenant.TenantSettings.AppIcon)</i>
            }
            <Language Tag="Welcome" ReplaceSpaces="true" /> @Model.User.FirstName
        </h1>
    }
}

@code {
    protected bool _loadedData = false;
    protected bool _loading = true;
    protected string _pageName = "home";

    public void Dispose()
    {
        Model.OnChange -= OnDataModelUpdated;
    }

    protected override void OnInitialized()
    {
        Model.OnChange += OnDataModelUpdated;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if(Model.Loaded && Model.LoggedIn) {
            if(!_loadedData) {
                _loadedData = true;
                await LoadData();
            }
        }
    }

    protected void OnDataModelUpdated()
    {
        if(Model.View == _pageName) {
            StateHasChanged();
        }
    }

    protected async Task LoadData()
    {
        // Load any app-specific data here.
        _loading = false;
        await MyLoadDataAsync();
        StateHasChanged();
    }

    protected string LogoUrl {
        get {
            if(Model.Tenant.TenantSettings.Logo.HasValue && Model.Tenant.TenantSettings.Logo != Guid.Empty) {
                return Model.ApplicationUrl + "File/View/" + ((Guid)Model.Tenant.TenantSettings.Logo).ToString();
            } else {
                return String.Empty;
            }
        }
    }
}

@if(Model.Loaded && Model.View == "home") {
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            @for(int i = _hidePAT ? 1 : 0; i < StepNames.Length; i++) {
                <li class="breadcrumb-item@(currentStep == i ? " active" : "")">
                    @StepNames[i]
                </li>
            }
        </ol>
    </nav>

    <div class="card">
        @{
            switch(StepNames[currentStep]) {
                case DataObjects.StepNameList.SelectPAT:
                    <div class="card-header">
                        Azure DevOps Credentials
                        <div class="card-header-buttons text-end">
                            <button class="btn btn-primary"
                                    @onclick="PATandOrgNameChangedWizard"
                                    disabled="@(_loading || string.IsNullOrWhiteSpace(DevOpsPAT) || string.IsNullOrWhiteSpace(OrgName))">
                                Next
                                <Icon Name="Next" />
                            </button>
                        </div>
                    </div>
                    break;

                case DataObjects.StepNameList.SelectProject:
                    <div class="card-header">
                        Select Project
                        <div class="card-header-buttons text-end">
                            <button class="btn btn-primary" @onclick="(e) => NextStep(DataObjects.StepNameList.SelectProject)" disabled="@(_loading || string.IsNullOrEmpty(SelectedProjectId))">
                                Next
                                <Icon Name="Next" />
                            </button>
                        </div>
                    </div>
                    break;

                case DataObjects.StepNameList.SelectRepository:
                    <div class="card-header">
                        Select Repository
                        <div class="card-header-buttons text-end">
                            <button class="btn btn-secondary me-2" @onclick="PrevStep" disabled="@(_loading)">
                                <Icon Name="Previous" />
                                Back
                            </button>
                            <button class="btn btn-primary" @onclick="(e) => NextStep(DataObjects.StepNameList.SelectRepository)" disabled="@(_loading || string.IsNullOrEmpty(SelectedRepoId))">
                                Next
                                <Icon Name="Next" />
                            </button>
                        </div>
                    </div>
                    break;

                case DataObjects.StepNameList.SelectBranch:
                    <div class="card-header">
                        Select Branch
                        <div class="card-header-buttons text-end">
                            <button class="btn btn-secondary me-2" @onclick="PrevStep" disabled="@(_loading)">
                                <Icon Name="Previous" />
                                Back
                            </button>
                            <button class="btn btn-primary" @onclick="(e) => NextStep(DataObjects.StepNameList.SelectBranch)" disabled="@(_loading || string.IsNullOrEmpty(SelectedBranch))">
                                Next
                                <Icon Name="Next" />
                            </button>
                        </div>
                    </div>
                    break;

                case DataObjects.StepNameList.SelectCsprojFile:
                    <div class="card-header">
                        Select .csproj File
                        <div class="card-header-buttons text-end">
                            <button class="btn btn-secondary me-2" @onclick="PrevStep" disabled="@(_loading)">
                                <Icon Name="Previous" />
                                Back
                            </button>
                            <button class="btn btn-primary" @onclick="(e) => NextStep(DataObjects.StepNameList.SelectCsprojFile)" disabled="@(_loading)">
                                Next
                                <Icon Name="Next" />
                            </button>
                        </div>
                    </div>
                    break;

                case DataObjects.StepNameList.EnvironmentSettings:
                    <div class="card-header">
                        Environment Settings
                        <div class="card-header-buttons text-end">
                            <button class="btn btn-secondary me-2" @onclick="PrevStep" disabled="@(_loading)">
                                <Icon Name="Previous" />
                                Back
                            </button>
                            <button class="btn btn-primary" @onclick="(e) => NextStep(DataObjects.StepNameList.EnvironmentSettings)" disabled="@(_loading)">
                                Next
                                <Icon Name="Next" />
                            </button>
                        </div>
                    </div>
                    break;

                case DataObjects.StepNameList.SelectPipelineSelection:
                    <div class="card-header">
                        Pipeline Selection
                        <div class="card-header-buttons text-end">
                            <button class="btn btn-secondary me-2" @onclick="PrevStep" disabled="@(_loading)">
                                <Icon Name="Previous" />
                                Back
                            </button>
                            <button class="btn btn-primary" @onclick="(e) => NextStep(DataObjects.StepNameList.SelectPipelineSelection)" disabled="@(_loading || (SelectedPipelineId <= 0 && string.IsNullOrWhiteSpace(NewPipelineName)))">
                                Next
                                <Icon Name="Next" />
                            </button>
                        </div>
                    </div>
                    break;

                case DataObjects.StepNameList.YAMLPreviewAndSave:
                    <div class="card-header">
                        YAML Preview & Save
                        <div class="card-header-buttons text-end">
                            <button class="btn btn-secondary me-2" @onclick="PrevStep" disabled="@(_loading)">
                                <Icon Name="Previous" />
                                Back
                            </button>
                            <button class="btn btn-success" @onclick="(e) => NextStep(DataObjects.StepNameList.YAMLPreviewAndSave)" disabled="@(_loading)">
                                <Icon Name="Save" />
                                Save YAML & Pipeline Changes
                            </button>
                        </div>
                    </div>
                    break;

                case DataObjects.StepNameList.Completed:
                    <div class="card-header">Completed</div>
                    break;
            }
        }

        <div class="card-body">
            @{
                switch(StepNames[currentStep]) {
                    case DataObjects.StepNameList.SelectPAT:
                        <div class="mb-3">
                            <label for="patInput" class="form-label">Personal Access Token (PAT):</label>
                            <input type="password" disabled="@(_loading)" id="patInput" class="form-control" @bind="DevOpsPAT" @bind:event="oninput" placeholder="Enter your Azure DevOps PAT" />
                        </div>
                        <div class="mb-3">
                            <label for="orgNameInput" class="form-label">Organization Name:</label>
                            <input type="text" disabled="@(_loading)" id="orgNameInput" class="form-control" @bind="OrgName" @bind:event="oninput" placeholder="Enter your Organization Name" />
                        </div>

                        <div class="mb-3">
                            <p>Or <a href="@Helpers.BuildUrl("login")">Login</a> to use the PAT and Org Information stored in the appsettings.json file.</p>
                        </div>
                        break;

                    case DataObjects.StepNameList.SelectProject:
                        <label class="form-label">Project:</label>
                        <select class="form-select" @onchange="ProjectChangedWizard" disabled="@_loading">
                            <option value="">-- Select Project --</option>
                            @if(DevopsProjectInfos != null) {
                                @foreach(var proj in DevopsProjectInfos.OrderBy(o => (string.Empty + o.ProjectName).ToLower())) {
                                    <option value="@proj.ProjectId" selected="@(proj.ProjectId == SelectedProjectInfo?.ProjectId ? "selected" : null)">@proj.ProjectName</option>
                                }
                            }
                        </select>
                        break;

                    case DataObjects.StepNameList.SelectRepository:
                        <label class="form-label">Repository:</label>
                        <select class="form-select" @onchange="RepoChangedWizard" disabled="@_loading">
                            <option value="">-- Select Repository --</option>
                            @if(SelectedProjectInfo != null) {
                                @foreach(var repo in SelectedProjectInfo.GitRepos.OrderBy(o => (string.Empty + o.RepoName).ToLower())) {
                                    <option value="@repo.RepoId" selected="@(repo.RepoId == SelectedRepoInfo?.RepoId ? "selected" : null)">@repo.RepoName</option>
                                }
                            }
                        </select>
                        break;

                    case DataObjects.StepNameList.SelectBranch:
                        <label class="form-label">Branch:</label>
                        <select class="form-select" @onchange="BranchChangedWizard" disabled="@_loading">
                            <option value="">-- Select Branch --</option>
                            @if(SelectedRepoInfo != null) {
                                @foreach(var branch in SelectedRepoInfo.GitBranches.OrderBy(o => (string.Empty + o.BranchName).ToLower())) {
                                    <option value="@branch.BranchName" selected="@(branch.BranchName == SelectedBranchInfo?.BranchName ? "selected" : null)">@branch.BranchName</option>
                                }
                            }
                        </select>
                        break;

                    case DataObjects.StepNameList.SelectCsprojFile:
                        if(SelectedBranchInfo == null || SelectedBranchInfo.Files == null || SelectedBranchInfo.Files.Count() == 0) {
                            <p>No file structure available for the selected branch.</p>
                        } else {
                            var csprojFiles = SelectedBranchInfo.Files
                            .Where(f => f.FileType.EndsWith(".csproj", StringComparison.OrdinalIgnoreCase))
                            .ToList();
                            if(csprojFiles.Count == 0) {
                                <p>No .csproj files found in this branch.</p>
                            } else {
                                <label class="form-label">Choose a .csproj file:</label>
                                <select class="form-select" @onchange="CsProjectFileChangedWizard" disabled="@_loading">
                                    <option value="">-- Select .csproj file --</option>
                                    @foreach(var file in csprojFiles.OrderBy(f => f.Path)) {
                                        <option value="@file.Path" selected="@(file.Path == SelectedCsprojPath ? "selected" : null)">@file.Path</option>
                                    }
                                </select>
                            }
                        }
                        break;

                    case DataObjects.StepNameList.EnvironmentSettings:
                        <p>Select environments to configure (optional):</p>
                        foreach(var envKey in GlobalSettings.App.EnvironmentOptions.Keys) {
                            <div class="form-check mb-2">
                                <input type="checkbox" class="form-check-input" checked="@(EnvSettings.ContainsKey(envKey))" id="envCheck_@envKey" @onchange="@(e => EnvironmentChangedWizard(envKey, e))" disabled="@_loading" />
                                <label class="form-check-label" for="envCheck_@envKey">@envKey Environment</label>
                            </div>
                            if(EnvSettings.Keys.Contains(envKey)) {
                                var envSetting = EnvSettings[envKey];

                                // Pull IIS options from API-backed cache
                                var _siteOptsList = GetWebsiteOptions(envKey).ToList();
                                var _vpathOptsList = GetVirtualPathOptions(envKey, envSetting.WebsiteName).ToList();
                                var _poolOptsList = GetAppPoolOptions(envKey).ToList();

                                bool _siteLocked = _siteOptsList.Any() && _siteOptsList.Any(o => string.Equals(envSetting.WebsiteName, o, StringComparison.OrdinalIgnoreCase));
                                bool _vpathLocked = _vpathOptsList.Any() && _vpathOptsList.Any(v => string.Equals(envSetting.VirtualPath, v, StringComparison.OrdinalIgnoreCase));
                                bool _poolLocked = _poolOptsList.Any() && _poolOptsList.Any(p => string.Equals(envSetting.AppPoolName, p, StringComparison.OrdinalIgnoreCase));

                                <div class="border p-2 mb-3">
                                    <h6>@envKey Environment Settings</h6>
                                    <label class="form-label">IIS Deployment Type:</label>
                                    <select class="form-select" @onchange="@(e => EnvironmentDeploymentTypeChangedWizard(envKey, e))" disabled="@_loading">
                                        <option value="IISWebsite" selected="@(envSetting.IISDeploymentType == "IISWebsite" ? "selected" : null)">IISWebsite</option>
                                        <option value="IISWebsiteAuth" selected="@(envSetting.IISDeploymentType == "IISWebsiteAuth" ? "selected" : null)">IISWebsiteAuth</option>
                                        <option value="IISWebApplication" selected="@(envSetting.IISDeploymentType == "IISWebApplication" ? "selected" : null)">IISWebApplication</option>
                                        <option value="IISWebApplicationAuth" selected="@(envSetting.IISDeploymentType == "IISWebApplicationAuth" ? "selected" : null)">IISWebApplicationAuth</option>
                                    </select>

                                    @if(_siteOptsList.Any()) {
                                        <label class="form-label mt-2">Website Name (choose from IIS):</label>
                                        <select class="form-select" @onchange="@(e => EnvironmentWebsiteChangedWizard(envKey, e))" disabled="@_loading">
                                            <option value="">-- Select Website --</option>
                                            @foreach(var opt in _siteOptsList) {
                                                <option value="@opt" selected="@(string.Equals(envSetting.WebsiteName, opt, StringComparison.OrdinalIgnoreCase) ? "selected" : null)">@opt</option>
                                            }
                                        </select>
                                    }

                                    <label class="form-label mt-2">Website Name:</label>
                                    <input type="text" class="form-control @(_siteLocked ? "bg-light" : null)" @bind="envSetting.WebsiteName" @bind:event="oninput" disabled="@(_loading || _siteLocked)" />

                                    @if(envSetting.IISDeploymentType == "IISWebApplication" || envSetting.IISDeploymentType == "IISWebApplicationAuth") {
                                        @if(_vpathOptsList.Any()) {
                                            <label class="form-label mt-2">Virtual Path (choose from IIS):</label>
                                            <select class="form-select" @onchange="@(e => EnvironmentVirtualPathChangedWizard(envKey, e))" disabled="@_loading">
                                                <option value="">-- Select Virtual Path --</option>
                                                @foreach(var v in _vpathOptsList) {
                                                    <option value="@v" selected="@(string.Equals(envSetting.VirtualPath, v, StringComparison.OrdinalIgnoreCase) ? "selected" : null)">@v</option>
                                                }
                                            </select>
                                        }

                                        <label class="form-label mt-2">Virtual Path:</label>
                                        <input type="text" class="form-control @(_vpathLocked ? "bg-light" : null)" @bind="envSetting.VirtualPath" @bind:event="oninput" placeholder="Enter virtual path" disabled="@(_loading || _vpathLocked)" />
                                    }

                                    @if(envSetting.IISDeploymentType.Contains("Auth")) {
                                        <label class="form-label mt-2">Auth User:</label>
                                        <input type="text" class="form-control" @bind="envSetting.AuthUser" @bind:event="oninput" placeholder="Enter the Auth User" disabled="@_loading" />
                                    }

                                    @if(_poolOptsList.Any()) {
                                        <label class="form-label mt-2">App Pool Name (choose from IIS):</label>
                                        <select class="form-select" @onchange="@(e => EnvironmentAppPoolChangedWizard(envKey, e))" disabled="@_loading">
                                            <option value="">-- Select App Pool --</option>
                                            @foreach(var ap in _poolOptsList) {
                                                <option value="@ap" selected="@(string.Equals(envSetting.AppPoolName, ap, StringComparison.OrdinalIgnoreCase) ? "selected" : null)">@ap</option>
                                            }
                                        </select>
                                    }

                                    <label class="form-label mt-2">App Pool Name:</label>
                                    <input type="text" class="form-control @(_poolLocked ? "bg-light" : null)" @bind="envSetting.AppPoolName" @bind:event="oninput" disabled="@(_loading || _poolLocked)" />

                                    <label class="form-label mt-2">Variable Group Name:</label>
                                    <input type="text" class="form-control" @bind="envSetting.VariableGroupName" @bind:event="oninput" placeholder="Enter variable group name" disabled="@_loading" />

                                    <div class="mt-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <label class="form-label mb-0">Custom IIS Bindings</label>
                                            <button type="button"
                                                    class="btn btn-sm btn-outline-primary"
                                                    aria-label="Add IIS binding"
                                                    @onclick="() => AddCustomBinding(envKey)"
                                                    disabled="@_loading">
                                                Add Binding
                                            </button>
                                        </div>
                                        <p class="form-text mb-2">Define host header bindings for this environment. Leave Path blank for the site root.</p>

                                        @if(envSetting.CustomBindings == null || !envSetting.CustomBindings.Any()) {
                                            <div class="alert alert-info" role="status">
                                                No bindings defined. Use "Add Binding" to configure host headers.
                                            </div>
                                        } else {
                                            @foreach(var binding in envSetting.CustomBindings.Select((b, index) => new { Binding = b, Index = index })) {
                                                <div class="border rounded p-2 mb-2" @key="envKey.ToString() + \"_binding_\" + binding.Index">
                                                    <div class="row g-2 align-items-end">
                                                        <div class="col-12 col-md-3">
                                                            <label class="form-label">Protocol</label>
                                                            <select class="form-select"
                                                                    aria-label="Binding protocol"
                                                                    value="@binding.Binding.Protocol"
                                                                    @onchange="(e) => BindingProtocolChanged(envKey, binding.Index, e)"
                                                                    disabled="@_loading">
                                                                <option value="https">HTTPS</option>
                                                                <option value="http">HTTP</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-12 col-md-4">
                                                            <label class="form-label">Hostname</label>
                                                            <input type="text"
                                                                   class="form-control"
                                                                   aria-label="Binding hostname"
                                                                   value="@binding.Binding.Hostname"
                                                                   @oninput="(e) => BindingHostnameChanged(envKey, binding.Index, e)"
                                                                   disabled="@_loading" />
                                                        </div>
                                                        <div class="col-6 col-md-2">
                                                            <label class="form-label">Port</label>
                                                            <input type="text"
                                                                   class="form-control"
                                                                   aria-label="Binding port"
                                                                   inputmode="numeric"
                                                                   pattern="[0-9]*"
                                                                   value="@binding.Binding.Port"
                                                                   @oninput="(e) => BindingPortChanged(envKey, binding.Index, e)"
                                                                   disabled="@_loading" />
                                                        </div>
                                                        <div class="col-6 col-md-3">
                                                            <label class="form-label">Path</label>
                                                            <input type="text"
                                                                   class="form-control"
                                                                   aria-label="Binding path"
                                                                   placeholder="/"
                                                                   value="@(@binding.Binding.Path ?? string.Empty)"
                                                                   @oninput="(e) => BindingPathChanged(envKey, binding.Index, e)"
                                                                   disabled="@_loading" />
                                                        </div>
                                                    </div>
                                                    <div class="text-end mt-2">
                                                        <button type="button"
                                                                class="btn btn-sm btn-outline-danger"
                                                                aria-label="@($"Remove binding {binding.Index + 1} for {envKey}")"
                                                                @onclick="() => RemoveCustomBinding(envKey, binding.Index)"
                                                                disabled="@_loading">
                                                            Remove Binding
                                                        </button>
                                                    </div>
                                                </div>
                                            }
                                        }
                                    </div>
                                </div>
                            }
                        }
                        break;

                    case DataObjects.StepNameList.SelectPipelineSelection:
                        <label class="form-label">Select Existing Pipeline:</label>
                        <select class="form-select" @onchange="@(e => PipelineChangedWizard(e))" disabled="@_loading">
                            <option value="">-- Select Pipeline or Create New --</option>
                            @foreach(var group in DevopsPipelineDefinitions.GroupBy(p => p.Path).OrderBy(g => g.Key)) {
                                <optgroup label="@group.Key">
                                    @foreach(var pipe in group.OrderBy(p => p.Name)) {
                                        <option value="@pipe.Id" selected="@(pipe.Id == SelectedPipelineInfo?.Id ? "selected" : null)">@pipe.Name</option>
                                    }
                                </optgroup>
                            }
                        </select>

                        @if(SelectedPipelineId <= 0 || SelectedPipelineId == null) {
                            <div class="mt-3">
                                <label class="form-label">New Pipeline Name:</label>
                                <input type="text" class="form-control" @bind="NewPipelineName" @bind:event="oninput" placeholder="Enter pipeline name" />
                            </div>
                        } else {
                            DataObjects.DevopsPipelineDefinition? pipeline = DevopsPipelineDefinitions?.FirstOrDefault(p => p.Id == SelectedPipelineId);
                            if(pipeline != null) {
                                <div class="mt-3">
                                    <p><strong>Pipeline Name:</strong> @pipeline.Name</p>
                                    <p><strong>Pipeline Id:</strong> @pipeline.Id</p>
                                    <p><strong>YML File:</strong> @pipeline.YamlFileName</p>
                                </div>
                            }
                        }
                        break;

                    case DataObjects.StepNameList.YAMLPreviewAndSave:
                        <div class="row yaml-diff mt-4">
                            <div class="col-12">
                                <h5>YAML Diff</h5>
                                @if(string.IsNullOrWhiteSpace(ExistingYamlContent)) {
                                    <p>Nothing to diff.</p>
                                } else {
                                    <MonacoEditor Id="yaml-diff-editor"
                                                  Language="@MonacoEditor.MonacoLanguage.yaml"
                                                  ReadOnly="true"
                                                  ValueToDiff="@ExistingYamlContent"
                                                  @bind-Value="NewYamlContent" />
                                }
                            </div>
                        </div>
                        break;

                    case DataObjects.StepNameList.Completed:
                        <div class="mb-3">
                            <p>
                                The YAML Pipeline has been created. Remember to edit your variable groups before triggering a deployment.
                            </p>
                            <div class="mt-3">
                                <h5>Resources Created / Accessible</h5>
                                <ul>
                                    @if(SelectedProjectInfo != null && !string.IsNullOrWhiteSpace(SelectedProjectInfo.ResourceUrl)) {
                                        <li>
                                            <a target="_blank" href="@SelectedProjectInfo.ResourceUrl">Project: @SelectedProjectInfo.ProjectName</a>
                                        </li>
                                    }
                                    @if(SelectedBranchInfo != null && !string.IsNullOrWhiteSpace(SelectedBranchInfo.ResourceUrl)) {
                                        <li>
                                            <a target="_blank" href="@SelectedBranchInfo.ResourceUrl">Branch: @SelectedBranchInfo.BranchName</a>
                                        </li>
                                    }
                                    @if(LastSavedPipelineDefinition == null || string.IsNullOrWhiteSpace(LastSavedPipelineDefinition.ResourceUrl)) {
                                        <li>
                                            <div class="d-flex align-items-center">
                                                <div class="spinner-border spinner-border-sm me-2" role="status" aria-label="Saving pipeline info">
                                                    <span class="visually-hidden">Saving pipeline info</span>
                                                </div>
                                                <span>Saving Pipeline...</span>
                                            </div>
                                        </li>
                                    } else {
                                        <li>
                                            <a target="_blank" href="@LastSavedPipelineDefinition.ResourceUrl">Pipeline: @LastSavedPipelineDefinition.Name</a>
                                        </li>
                                    }
                                </ul>
                            </div>
                        </div>
                        break;
                }
            }

            @if(_loading) {
                <div class="d-flex flex-column justify-content-center align-items-center my-5">
                    <div class="spinner-border text-primary" role="status" aria-label="Loading DevOps Info">
                        <span class="visually-hidden">Loading DevOps Info</span>
                    </div>
                    <div class="mt-3">Loading DevOps Info... please wait, this can take up to a minute.</div>
                </div>
            } else if(_loadingMessages.Any()) {
                <div class="update-messages-header">Update Information</div>

                <div class="update-messages">
                    <table class="table table-striped">
                        <thead>
                            <tr class="table-dark">
                                <th scope="col">Message</th>
                                <th scope="col">Created</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach(var message in _loadingMessages) {
                                <tr>
                                    <td>@message.Message</td>
                                    <td>@message.Created</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
}

@code {
    protected async Task MyLoadDataAsync()
    {        
        // Keep base page responsible for ValidateUrl & TenantCodeFromUrl.
        if(Model.LoggedIn) {
            _hidePAT = true;
            currentStep = 1; // Bypass PAT step for authenticated users.
            _loading = true;
            DevOpsPAT = "user is logged in, doesn't matter what this value is";
            OrgName = "user is logged in, this value is ignored, put anything here";
            await PATandOrgNameChangedWizard();
            _loading = false;

            // Prefetch IIS options once on first render so Environment step is instant.
            await PrefetchIISDataIfNeeded();

            StateHasChanged();
        } else {
            _loading = true;
            OrgName = string.Empty;
            DevOpsPAT = string.Empty;
            currentStep = 0; // Show PAT/org collection for unauthenticated users.
            _loading = false;

            // Prefetch IIS options once on first render so Environment step is instant.
            await PrefetchIISDataIfNeeded();

            StateHasChanged();
        }        
    }

    // ---------------------------
    // State & Models
    // ---------------------------
    private bool _hidePAT = false;

    private int currentStep = 0;
    private string? SelectedProjectId = string.Empty;
    private string? SelectedRepoId = string.Empty;
    private string? SelectedBranch = string.Empty;
    private string? SelectedCsprojPath = string.Empty;
    private string? NewPipelineName = string.Empty;
    private int? SelectedPipelineId = 0;
    private string ExistingYamlContent = string.Empty;
    private string NewYamlContent { get; set; } = string.Empty;

    // Captured result of the save/create pipeline operation
    private DataObjects.BuildDefinition? LastSavedPipelineDefinition { get; set; } = null;

    // PAT and organization name for anonymous usage when not logged in.
    private string DevOpsPAT { get; set; } = string.Empty;
    private string OrgName { get; set; } = string.Empty;

    // State for environment configuration checkboxes.
    private Dictionary<GlobalSettings.EnvironmentType, DataObjects.EnvSetting> EnvSettings = new();

    private static readonly JsonSerializerOptions BindingSerializerOptions = new JsonSerializerOptions
    {
        PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
        ReadCommentHandling = JsonCommentHandling.Skip,
        AllowTrailingCommas = true,
        DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull,
        WriteIndented = false
    };

    private string[] StepNames = [
        DataObjects.StepNameList.SelectPAT,
        DataObjects.StepNameList.SelectProject,
        DataObjects.StepNameList.SelectRepository,
        DataObjects.StepNameList.SelectBranch,
        DataObjects.StepNameList.SelectCsprojFile,
        DataObjects.StepNameList.EnvironmentSettings,
        DataObjects.StepNameList.SelectPipelineSelection,
        DataObjects.StepNameList.YAMLPreviewAndSave,
        DataObjects.StepNameList.Completed,
    ];

    private List<DataObjects.DevopsProjectInfo> DevopsProjectInfos { get; set; } = new();
    private List<DataObjects.DevopsVariableGroup> DevopsVariableGroups { get; set; } = new();
    private List<DataObjects.DevopsPipelineDefinition> DevopsPipelineDefinitions { get; set; } = new();

    private List<Guid> _loadingMessagesIds = new List<Guid>();
    private List<LoadingMessage> _loadingMessages = new List<LoadingMessage>();

    protected DataObjects.DevopsProjectInfo? SelectedProjectInfo => DevopsProjectInfos?.FirstOrDefault(p => p.ProjectId == SelectedProjectId);
    protected DataObjects.DevopsGitRepoInfo? SelectedRepoInfo => SelectedProjectInfo?.GitRepos.FirstOrDefault(r => r.RepoId == SelectedRepoId);
    protected DataObjects.DevopsGitRepoBranchInfo? SelectedBranchInfo => SelectedRepoInfo?.GitBranches.FirstOrDefault(r => r.BranchName == SelectedBranch);
    protected DataObjects.DevopsPipelineDefinition? SelectedPipelineInfo => DevopsPipelineDefinitions?.FirstOrDefault(p => p.Id == SelectedPipelineId);

    protected DataObjects.DevOpsPipelineRequest? DevOpsPipelineRequest => new DataObjects.DevOpsPipelineRequest {
        Pat = DevOpsPAT,
        OrgName = OrgName,
        ProjectId = SelectedProjectInfo?.ProjectId ?? "",
        RepoId = SelectedRepoInfo?.RepoId ?? "",
        Branch = SelectedBranch ?? "",
        YAMLFileName = SelectedPipelineInfo?.YamlFileName ?? "",
        PipelineId = SelectedPipelineId.GetValueOrDefault(0),
        PipelineName = SelectedPipelineId > 0 ? string.Empty : NewPipelineName ?? "",
        EnvironmentSettings = BuildEnvironmentSettingsPayload(),
        CsProjectFile = SelectedCsprojPath ?? "",
        ConnectionId = Model.SignalrClientRegistration?.ConnectionId
    };

    protected class LoadingMessage
    {
        public DateTime Created { get; set; } = DateTime.Now;
        public string Message { get; set; } = string.Empty;
    }

    // ---------------------------
    // Methods
    // ---------------------------

    private void ClearLoadingMessages()
    {
        // Retain messages per your latest logic (no-op).
        // _loadingMessagesIds = new List<Guid>();
        // _loadingMessages = new List<LoadingMessage>();
        // StateHasChanged();
    }

    private async Task NextStep(string? stepName = "")
    {
        ClearLoadingMessages();
        if(currentStep < StepNames.Length - 1) {
            currentStep++;
            StateHasChanged();
        }

        switch(stepName) {
            case DataObjects.StepNameList.SelectProject:
                if(!string.IsNullOrWhiteSpace(SelectedProjectId)) {
                    _loading = true;
                    try {
                        List<DataObjects.DevopsPipelineDefinition>? results = await Helpers.GetOrPost<List<DataObjects.DevopsPipelineDefinition>>(DataObjects.Endpoints.DevOps.GetDevOpsPipelines +
                            "?connectionId=" + Uri.EscapeDataString((string.Empty + Model?.SignalrClientRegistration?.ConnectionId).Trim()) +
                            "&projectId=" + Uri.EscapeDataString($"{SelectedProjectInfo?.ProjectId}") +
                            "&orgName=" + Uri.EscapeDataString(OrgName) +
                            "&pat=" + Uri.EscapeDataString(DevOpsPAT)
                        );

                        DevopsPipelineDefinitions = results?.ToList() ?? new List<DataObjects.DevopsPipelineDefinition>();

                        // Auto-select if only one.
                        if(DevopsPipelineDefinitions != null && DevopsPipelineDefinitions.Count == 1) {
                            SelectedPipelineId = DevopsPipelineDefinitions[0].Id;
                        }
                    } catch {
                        // Swallow per your original pattern.
                    } finally {
                        _loading = false;
                        StateHasChanged();
                    }

                    await Task.Delay(800);
                }
                break;

            case DataObjects.StepNameList.SelectRepository:
                // selection driven by dropdown
                break;

            case DataObjects.StepNameList.SelectBranch:
                // selection driven by dropdown
                break;

            case DataObjects.StepNameList.SelectCsprojFile:
                // selection driven by dropdown
                break;

            case DataObjects.StepNameList.EnvironmentSettings:
                // no-op unless configured
                break;

            case DataObjects.StepNameList.SelectPipelineSelection:
                if(!string.IsNullOrWhiteSpace(NewPipelineName) || SelectedPipelineId != null) {
                    ExistingYamlContent = string.Empty;

                    var pipeline = DevopsPipelineDefinitions.FirstOrDefault(p => p.Id == SelectedPipelineId);
                    if(pipeline != null && !string.IsNullOrEmpty(pipeline.YamlFileName)) {
                        var filePath = pipeline.YamlFileName;

                        try {
                            string? results = await Helpers.GetOrPost<string>(DataObjects.Endpoints.DevOps.GetDevOpsYmlFileContent +
                                "?connectionId=" + Uri.EscapeDataString((string.Empty + Model?.SignalrClientRegistration?.ConnectionId).Trim()) +
                                "&filePath=" + Uri.EscapeDataString($"{filePath}") +
                                "&projectId=" + Uri.EscapeDataString($"{SelectedProjectInfo?.ProjectId}") +
                                "&repoId=" + Uri.EscapeDataString($"{SelectedRepoInfo?.RepoId}") +
                                "&branchName=" + Uri.EscapeDataString($"{SelectedBranchInfo?.BranchName}") +
                                "&orgName=" + Uri.EscapeDataString(OrgName) +
                                "&pat=" + Uri.EscapeDataString(DevOpsPAT)
                            );
                            ExistingYamlContent = results;
                        } catch {
                            ExistingYamlContent = "";
                        }

                    } else {
                        SelectedPipelineId = 0;
                        ExistingYamlContent = "";
                    }

                    NewYamlContent = string.Empty;

                    try {
                        var response = await Helpers.GetOrPost<string>($"{DataObjects.Endpoints.DevOps.PreviewDevOpsYmlFileContents}", DevOpsPipelineRequest);
                        if(!string.IsNullOrWhiteSpace(response)) {
                            NewYamlContent = response;
                            _loadingMessages.Insert(0, new LoadingMessage { Message = "Preview fetched successfully.", Created = DateTime.UtcNow });
                        } else {
                            _loadingMessages.Insert(0, new LoadingMessage { Message = $"Error", Created = DateTime.UtcNow });
                        }
                    } catch(Exception ex) {
                        _loadingMessages.Insert(0, new LoadingMessage { Message = $"Exception: {ex.Message}", Created = DateTime.UtcNow });
                    } finally {
                        _loading = false;
                        StateHasChanged();
                    }
                }
                break;

            case DataObjects.StepNameList.YAMLPreviewAndSave:
                try {
                    LastSavedPipelineDefinition = null;
                    var createOrUpdateResult = await Helpers.GetOrPost<DataObjects.BuildDefinition>($"{DataObjects.Endpoints.DevOps.CreateOrUpdateDevOpsPipeline}", DevOpsPipelineRequest);
                    if(createOrUpdateResult != null && createOrUpdateResult.Id > 0) {
                        LastSavedPipelineDefinition = createOrUpdateResult;
                        _loadingMessages.Insert(0, new LoadingMessage { Message = "Pipeline created/updated successfully.", Created = DateTime.UtcNow });
                    } else {
                        _loadingMessages.Insert(0, new LoadingMessage { Message = $"Error", Created = DateTime.UtcNow });
                    }
                } catch(Exception ex) {
                    _loadingMessages.Insert(0, new LoadingMessage { Message = $"Exception: {ex.Message}", Created = DateTime.UtcNow });
                } finally {
                    _loading = false;

                    if(currentStep < StepNames.Length - 1) {
                        currentStep++;
                    }

                    StateHasChanged();
                }
                break;

            default:
                break;
        }
    }

    private void PrevStep()
    {
        ClearLoadingMessages();
        if(currentStep > 0) {
            currentStep--;
            StateHasChanged();
        }
    }

    private async Task PATandOrgNameChangedWizard()
    {
        ClearLoadingMessages();
        _loading = true;
        StateHasChanged();
        try {
            List<DataObjects.DevopsProjectInfo>? result = await Helpers.GetOrPost<List<DataObjects.DevopsProjectInfo>>(DataObjects.Endpoints.DevOps.GetDevOpsProjects +
                "?connectionId=" + Uri.EscapeDataString((string.Empty + Model?.SignalrClientRegistration?.ConnectionId).Trim()) +
                "&orgName=" + Uri.EscapeDataString(OrgName) +
                "&pat=" + Uri.EscapeDataString(DevOpsPAT)
            );

            if(result != null && result.Any()) {
                DevopsProjectInfos = result.ToList();
                currentStep = 1;
                StateHasChanged();

                if(DevopsProjectInfos.Count == 1) {
                    SelectedProjectId = DevopsProjectInfos[0].ProjectId;
                    await ProjectChangedWizard(new ChangeEventArgs { Value = SelectedProjectId });
                }
            } else {
                DevopsProjectInfos = new List<DataObjects.DevopsProjectInfo>();
            }
        } catch {
            // swallow per original pattern
        } finally {
            _loading = false;
            await Task.CompletedTask;
            StateHasChanged();
        }
    }

    private async Task ProjectChangedWizard(ChangeEventArgs e)
    {
        ClearLoadingMessages();
        _loading = true;
        StateHasChanged();
        try {
            SelectedProjectId = e.Value?.ToString() ?? "";
            SelectedRepoId = "";
            SelectedBranch = "";

            if(SelectedProjectInfo != null) {
                List<DataObjects.DevopsGitRepoInfo>? result = await Helpers.GetOrPost<List<DataObjects.DevopsGitRepoInfo>>(DataObjects.Endpoints.DevOps.GetDevOpsRepos +
                    "?connectionId=" + Uri.EscapeDataString((string.Empty + Model?.SignalrClientRegistration?.ConnectionId).Trim()) +
                    "&projectId=" + Uri.EscapeDataString($"{SelectedProjectInfo.ProjectId}") +
                    "&orgName=" + Uri.EscapeDataString(OrgName) +
                    "&pat=" + Uri.EscapeDataString(DevOpsPAT)
                );

                if(result != null && result.Any()) {
                    if(DevopsProjectInfos != null) {
                        foreach(var item in DevopsProjectInfos) {
                            if(item.ProjectId == SelectedProjectId) {
                                item.GitRepos = result;
                            } else {
                                item.GitRepos = new List<DataObjects.DevopsGitRepoInfo>();
                            }
                        }
                    }

                    if(result.Count == 1) {
                        SelectedRepoId = result[0].RepoId;
                        await RepoChangedWizard(new ChangeEventArgs { Value = SelectedRepoId });
                    }
                }
            }
        } catch {
        } finally {
            _loading = false;
            await Task.CompletedTask;
            StateHasChanged();
        }
    }

    private async Task RepoChangedWizard(ChangeEventArgs e)
    {
        ClearLoadingMessages();
        _loading = true;
        StateHasChanged();
        try {
            SelectedRepoId = e.Value?.ToString() ?? "";
            SelectedBranch = "";

            if(SelectedRepoInfo != null) {
                List<DataObjects.DevopsGitRepoBranchInfo>? result = await Helpers.GetOrPost<List<DataObjects.DevopsGitRepoBranchInfo>>(DataObjects.Endpoints.DevOps.GetDevOpsBranches +
                    "?connectionId=" + Uri.EscapeDataString((string.Empty + Model?.SignalrClientRegistration?.ConnectionId).Trim()) +
                    "&projectId=" + Uri.EscapeDataString($"{SelectedProjectInfo?.ProjectId}") +
                    "&repoId=" + Uri.EscapeDataString($"{SelectedRepoInfo?.RepoId}") +
                    "&orgName=" + Uri.EscapeDataString(OrgName) +
                    "&pat=" + Uri.EscapeDataString(DevOpsPAT)
                );

                if(result != null && result.Any()) {
                    if(DevopsProjectInfos != null) {
                        foreach(var project in DevopsProjectInfos) {
                            if(project.ProjectId == SelectedProjectId) {
                                foreach(var repo in project.GitRepos) {
                                    if(repo.RepoId == SelectedRepoInfo?.RepoId) {
                                        repo.GitBranches = result;
                                    } else {
                                        repo.GitBranches = new List<DataObjects.DevopsGitRepoBranchInfo>();
                                    }
                                }
                            }
                        }
                    }

                    if(result.Count == 1) {
                        SelectedBranch = result[0].BranchName;
                        await BranchChangedWizard(new ChangeEventArgs { Value = SelectedBranch });
                    }
                }
            }
        } catch {
        } finally {
            _loading = false;
            await Task.CompletedTask;
            StateHasChanged();
        }
    }

    private async Task BranchChangedWizard(ChangeEventArgs e)
    {
        ClearLoadingMessages();
        _loading = true;
        StateHasChanged();
        try {
            SelectedBranch = e.Value?.ToString() ?? "";

            if(SelectedBranchInfo != null) {
                List<DataObjects.DevopsFileItem>? result = await Helpers.GetOrPost<List<DataObjects.DevopsFileItem>>(DataObjects.Endpoints.DevOps.GetDevOpsFiles +
                    "?connectionId=" + Uri.EscapeDataString((string.Empty + Model?.SignalrClientRegistration?.ConnectionId).Trim()) +
                    "&projectId=" + Uri.EscapeDataString($"{SelectedProjectInfo?.ProjectId}") +
                    "&repoId=" + Uri.EscapeDataString($"{SelectedRepoInfo?.RepoId}") +
                    "&branchName=" + Uri.EscapeDataString($"{SelectedBranchInfo?.BranchName}") +
                    "&orgName=" + Uri.EscapeDataString(OrgName) +
                    "&pat=" + Uri.EscapeDataString(DevOpsPAT)
                );

                if(result != null && result.Any()) {
                    if(DevopsProjectInfos != null) {
                        foreach(var project in DevopsProjectInfos) {
                            if(project.ProjectId == SelectedProjectId) {
                                foreach(var repo in project.GitRepos) {
                                    if(repo.RepoId == SelectedRepoInfo?.RepoId) {
                                        foreach(var branch in repo.GitBranches) {
                                            if(branch.BranchName == SelectedBranchInfo?.BranchName) {
                                                branch.Files = result.ToList();
                                            } else {
                                                branch.Files = new List<DataObjects.DevopsFileItem>();
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }

                    var csprojFiles = result.Where(f => f.FileType.EndsWith(".csproj", StringComparison.OrdinalIgnoreCase)).ToList();
                    if(csprojFiles.Count == 1) {
                        SelectedCsprojPath = csprojFiles[0].Path;
                    }
                }
            }
        } catch {
        } finally {
            _loading = false;
            await Task.CompletedTask;
            StateHasChanged();
        }
    }

    private async Task CsProjectFileChangedWizard(ChangeEventArgs e)
    {
        ClearLoadingMessages();
        _loading = true;
        StateHasChanged();
        try {
            SelectedCsprojPath = e?.Value?.ToString() ?? "";
        } catch {
        } finally {
            _loading = false;
            await Task.CompletedTask;
            StateHasChanged();
        }
    }

    private async Task EnvironmentChangedWizard(GlobalSettings.EnvironmentType envKey, ChangeEventArgs e)
    {
        ClearLoadingMessages();
        _loading = true;
        StateHasChanged();
        try {
            bool isChecked = e.Value != null && bool.TryParse(e.Value.ToString(), out bool result) && result;

            if(isChecked) {
                string websiteNameDefault = GlobalSettings.App.EnvironmentOptions[envKey]?.Hostname ?? string.Empty;
                var setting = new DataObjects.EnvSetting {
                    EnvName = envKey,
                    IISDeploymentType = "IISWebApplication",
                    WebsiteName = "" + websiteNameDefault,
                    VirtualPath = "/" + SelectedProjectInfo?.ProjectName?.ToLower(),
                    AppPoolName = "" + websiteNameDefault + "." + SelectedProjectInfo?.ProjectName?.ToLower(),
                    VariableGroupName = $"{SelectedProjectInfo?.ProjectName}_{GlobalSettings.App.VariableGroupNameDefault}_{envKey}"
                };

                EnvSettings[envKey] = InitializeCustomBindingState(setting);
            } else {
                if(EnvSettings.ContainsKey(envKey)) {
                    EnvSettings.Remove(envKey);
                }
            }
        } catch {
        } finally {
            _loading = false;
            await Task.CompletedTask;
            StateHasChanged();
        }
    }

    private async Task EnvironmentDeploymentTypeChangedWizard(GlobalSettings.EnvironmentType envKey, ChangeEventArgs e)
    {
        ClearLoadingMessages();
        _loading = true;
        StateHasChanged();
        try {
            string deploymentType = e.Value?.ToString() ?? "";
            if(EnvSettings.ContainsKey(envKey)) {
                var setting = EnvSettings[envKey];
                var previousPath = setting.VirtualPath;
                setting.IISDeploymentType = deploymentType;
                if(deploymentType == "IISWebApplication" || deploymentType == "IISWebApplicationAuth") {
                    setting.VirtualPath = "/" + SelectedProjectInfo?.ProjectName?.ToLower();
                } else {
                    setting.VirtualPath = "";
                }
                SyncBindingPaths(setting, previousPath, setting.VirtualPath);
                NormalizeBindingsInPlace(setting);
            }
        } catch {
        } finally {
            _loading = false;
            await Task.CompletedTask;
            StateHasChanged();
        }
    }

    private async Task PipelineChangedWizard(ChangeEventArgs e)
    {
        try {
            ExistingYamlContent = string.Empty;
            NewYamlContent = string.Empty;
            SelectedPipelineId = 0;
            if(int.TryParse(e.Value?.ToString(), out int pid)) {
                SelectedPipelineId = pid;
            }
        } catch {
        } finally {
            _loading = false;
            await Task.CompletedTask;
            StateHasChanged();
        }
    }

    private async Task NavigateToStep(int i)
    {
        currentStep = i;
        await Task.CompletedTask;
        StateHasChanged();
    }

    // ---------------------------
    // IIS Data from API
    // ---------------------------

    private bool _iisPrefetched = false;

    // API-backed cache: environment -> IIS info
    private Dictionary<GlobalSettings.EnvironmentType, DataObjects.IISInfo> _iisData = new();

    // Map keys coming back from API (e.g., "AzureDev", "AzureCMS", "AzureProd") to our enum
    private static bool TryMapEnvKeyToEnum(string key, out GlobalSettings.EnvironmentType env)
    {
        env = default;
        if(string.IsNullOrWhiteSpace(key))
            return false;

        var k = key.Trim();
        // direct parse first
        if(Enum.TryParse<GlobalSettings.EnvironmentType>(k, true, out env))
            return true;

        // heuristic mapping
        if(k.Contains("dev", StringComparison.OrdinalIgnoreCase)) { env = GlobalSettings.EnvironmentType.DEV; return true; }
        if(k.Contains("prod", StringComparison.OrdinalIgnoreCase)) { env = GlobalSettings.EnvironmentType.PROD; return true; }
        if(k.Contains("cms", StringComparison.OrdinalIgnoreCase)) { env = GlobalSettings.EnvironmentType.CMS; return true; }

        return false;
    }

    private async Task PrefetchIISDataIfNeeded()
    {
        if(_iisPrefetched) {
            await Task.CompletedTask;
            return;
        }

        try {
            var apiResult = await Helpers.GetOrPost<Dictionary<string, DataObjects.IISInfo>>(DataObjects.Endpoints.DevOps.GetDevOpsIISInfo);

            _iisData.Clear();

            if(apiResult != null) {
                foreach(var kv in apiResult) {
                    if(TryMapEnvKeyToEnum(kv.Key, out var envKey) && kv.Value != null) {
                        _iisData[envKey] = kv.Value;
                    }
                }
            }
        } catch {
            // Ignore errors – UI will gracefully fall back to text inputs only.
            _iisData.Clear();
        }

        _iisPrefetched = true;
        await Task.CompletedTask;
    }

    private IEnumerable<string> GetWebsiteOptions(GlobalSettings.EnvironmentType envKey)
    {
        if(_iisData.TryGetValue(envKey, out var info) && info?.Sites != null) {
            return info.Sites
                .Select(s => s?.Name ?? string.Empty)
                .Where(n => !string.IsNullOrWhiteSpace(n))
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .OrderBy(n => n, StringComparer.OrdinalIgnoreCase);
        }
        return Array.Empty<string>();
    }

    private IEnumerable<string> GetVirtualPathOptions(GlobalSettings.EnvironmentType envKey, string websiteName)
    {
        if(_iisData.TryGetValue(envKey, out var info) && info?.Sites != null && !string.IsNullOrWhiteSpace(websiteName)) {
            var site = info.Sites.FirstOrDefault(s =>
                string.Equals(s?.Name ?? string.Empty, websiteName, StringComparison.OrdinalIgnoreCase));

            if(site?.Applications != null) {
                return site.Applications
                    .Select(a => a?.Path ?? string.Empty)
                    .Where(p => !string.IsNullOrWhiteSpace(p))
                    .Distinct(StringComparer.OrdinalIgnoreCase)
                    .OrderBy(p => p, StringComparer.OrdinalIgnoreCase);
            }
        }
        return Array.Empty<string>();
    }

    private IEnumerable<string> GetAppPoolOptions(GlobalSettings.EnvironmentType envKey)
    {
        if(_iisData.TryGetValue(envKey, out var info) && info != null) {
            var fromPools = (info.ApplicationPools ?? new List<DataObjects.ApplicationPool>())
                .Select(ap => ap?.Name ?? string.Empty)
                .Where(n => !string.IsNullOrWhiteSpace(n));

            var fromApps = (info.Sites ?? new List<DataObjects.Site>())
                .Where(s => s?.Applications != null)
                .SelectMany(s => s.Applications)
                .Select(a => a?.AppPool ?? string.Empty)
                .Where(n => !string.IsNullOrWhiteSpace(n));

            return fromPools
                .Concat(fromApps)
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .OrderBy(n => n, StringComparer.OrdinalIgnoreCase);
        }
        return Array.Empty<string>();
    }


    private async Task EnvironmentWebsiteChangedWizard(GlobalSettings.EnvironmentType envKey, ChangeEventArgs e)
    {
        try {
            var value = e?.Value?.ToString() ?? "";
            if(EnvSettings.ContainsKey(envKey)) {
                var setting = EnvSettings[envKey];
                var previous = setting.WebsiteName;
                setting.WebsiteName = value;
                SyncBindingHostnames(setting, previous, value);
                NormalizeBindingsInPlace(setting);
            }
        } catch {
        } finally {
            await Task.CompletedTask;
            StateHasChanged();
        }
    }

    private async Task EnvironmentVirtualPathChangedWizard(GlobalSettings.EnvironmentType envKey, ChangeEventArgs e)
    {
        try {
            var value = e?.Value?.ToString() ?? "";
            if(EnvSettings.ContainsKey(envKey)) {
                var setting = EnvSettings[envKey];
                var previous = setting.VirtualPath;
                setting.VirtualPath = value;
                SyncBindingPaths(setting, previous, value);
                NormalizeBindingsInPlace(setting);
            }
        } catch {
        } finally {
            await Task.CompletedTask;
            StateHasChanged();
        }
    }

    private async Task EnvironmentAppPoolChangedWizard(GlobalSettings.EnvironmentType envKey, ChangeEventArgs e)
    {
        try {
            var value = e?.Value?.ToString() ?? "";
            if(EnvSettings.ContainsKey(envKey)) {
                EnvSettings[envKey].AppPoolName = value;
                NormalizeBindingsInPlace(EnvSettings[envKey]);
            }
        } catch {
        } finally {
            await Task.CompletedTask;
            StateHasChanged();
        }
    }

    private Dictionary<GlobalSettings.EnvironmentType, DataObjects.EnvSetting> BuildEnvironmentSettingsPayload()
    {
        NormalizeAllEnvironmentBindings();
        return EnvSettings.ToDictionary(kvp => kvp.Key, kvp => CloneEnvSetting(kvp.Value));
    }

    private DataObjects.EnvSetting CloneEnvSetting(DataObjects.EnvSetting setting)
    {
        return new DataObjects.EnvSetting {
            EnvName = setting.EnvName,
            IISDeploymentType = setting.IISDeploymentType,
            WebsiteName = setting.WebsiteName,
            VirtualPath = setting.VirtualPath,
            AppPoolName = setting.AppPoolName,
            VariableGroupName = setting.VariableGroupName,
            BindingInfo = setting.BindingInfo,
            AuthUser = setting.AuthUser,
            CustomBindings = setting.CustomBindings?.Select(b => new DataObjects.CustomBindingDefinition {
                Protocol = b.Protocol,
                Hostname = b.Hostname,
                Port = b.Port,
                IpAddress = b.IpAddress,
                Path = b.Path,
                SniFlag = b.SniFlag,
                SslThumbprint = b.SslThumbprint,
                SslStoreName = b.SslStoreName
            }).ToList() ?? new List<DataObjects.CustomBindingDefinition>()
        };
    }

    private void NormalizeAllEnvironmentBindings()
    {
        foreach(var setting in EnvSettings.Values) {
            NormalizeBindingsInPlace(setting);
        }
    }

    private void NormalizeBindingsInPlace(DataObjects.EnvSetting setting)
    {
        if(setting == null) {
            return;
        }

        var normalized = NormalizeBindings(setting.CustomBindings);
        setting.CustomBindings = normalized;
        setting.BindingInfo = normalized.Any()
            ? JsonSerializer.Serialize(normalized, BindingSerializerOptions)
            : string.Empty;
    }

    private List<DataObjects.CustomBindingDefinition> NormalizeBindings(IEnumerable<DataObjects.CustomBindingDefinition>? bindings)
    {
        var normalized = new List<DataObjects.CustomBindingDefinition>();

        if(bindings != null) {
            foreach(var binding in bindings) {
                if(binding == null) {
                    continue;
                }

                var protocol = NormalizeProtocol(binding.Protocol);
                var port = NormalizePort(binding.Port, protocol);
                var host = (binding.Hostname ?? string.Empty).Trim();
                var ipAddress = string.IsNullOrWhiteSpace(binding.IpAddress) ? "*" : binding.IpAddress.Trim();
                var path = NormalizeBindingPath(binding.Path);

                bool? sniFlag = binding.SniFlag;
                if(protocol == "https") {
                    sniFlag = sniFlag ?? true;
                } else {
                    sniFlag = null;
                }

                normalized.Add(new DataObjects.CustomBindingDefinition {
                    Protocol = protocol,
                    Hostname = host,
                    Port = port,
                    IpAddress = ipAddress,
                    Path = path,
                    SniFlag = sniFlag,
                    SslThumbprint = string.IsNullOrWhiteSpace(binding.SslThumbprint) ? null : binding.SslThumbprint.Trim(),
                    SslStoreName = string.IsNullOrWhiteSpace(binding.SslStoreName) ? null : binding.SslStoreName.Trim()
                });
            }
        }

        return normalized;
    }

    private List<DataObjects.CustomBindingDefinition> ParseBindings(string? bindingInfo)
    {
        if(string.IsNullOrWhiteSpace(bindingInfo)) {
            return new List<DataObjects.CustomBindingDefinition>();
        }

        try {
            var parsed = JsonSerializer.Deserialize<List<DataObjects.CustomBindingDefinition>>(bindingInfo, BindingSerializerOptions);
            return NormalizeBindings(parsed);
        } catch {
            return new List<DataObjects.CustomBindingDefinition>();
        }
    }

    private static string NormalizeProtocol(string? protocol)
    {
        var value = (protocol ?? "https").Trim().ToLowerInvariant();
        return value switch {
            "http" => "http",
            "https" => "https",
            _ => "https"
        };
    }

    private static string NormalizePort(string? port, string protocol)
    {
        var trimmed = (port ?? string.Empty).Trim();
        if(string.IsNullOrWhiteSpace(trimmed)) {
            return DefaultPortForProtocol(protocol);
        }

        var digits = new string(trimmed.Where(char.IsDigit).ToArray());
        return string.IsNullOrWhiteSpace(digits) ? DefaultPortForProtocol(protocol) : digits;
    }

    private static string DefaultPortForProtocol(string? protocol)
    {
        return string.Equals(protocol, "https", StringComparison.OrdinalIgnoreCase) ? "443" : "80";
    }

    private static string? NormalizeBindingPath(string? path)
    {
        if(string.IsNullOrWhiteSpace(path)) {
            return null;
        }

        var trimmed = path.Trim();
        if(trimmed == "/") {
            return "/";
        }

        trimmed = trimmed.TrimStart('/');
        return string.IsNullOrWhiteSpace(trimmed) ? null : "/" + trimmed;
    }

    private DataObjects.EnvSetting InitializeCustomBindingState(DataObjects.EnvSetting setting)
    {
        setting.CustomBindings ??= new List<DataObjects.CustomBindingDefinition>();

        if(setting.CustomBindings.Count == 0 && !string.IsNullOrWhiteSpace(setting.BindingInfo)) {
            setting.CustomBindings = ParseBindings(setting.BindingInfo);
        }

        if(setting.CustomBindings.Count == 0) {
            string defaultHost = setting.WebsiteName?.Trim() ?? string.Empty;
            if(string.IsNullOrWhiteSpace(defaultHost) && GlobalSettings.App.EnvironmentOptions.TryGetValue(setting.EnvName, out var envDefaults)) {
                defaultHost = envDefaults?.Hostname ?? string.Empty;
            }

            setting.CustomBindings.Add(new DataObjects.CustomBindingDefinition {
                Protocol = "https",
                Hostname = defaultHost,
                Port = DefaultPortForProtocol("https"),
                IpAddress = "*",
                Path = NormalizeBindingPath(setting.VirtualPath),
                SniFlag = true
            });
        }

        NormalizeBindingsInPlace(setting);
        return setting;
    }

    private DataObjects.CustomBindingDefinition? GetBinding(DataObjects.EnvSetting setting, int index)
    {
        if(setting?.CustomBindings == null) {
            return null;
        }

        if(index < 0 || index >= setting.CustomBindings.Count) {
            return null;
        }

        return setting.CustomBindings[index];
    }

    private void AddCustomBinding(GlobalSettings.EnvironmentType envKey)
    {
        if(!EnvSettings.TryGetValue(envKey, out var setting)) {
            return;
        }

        setting.CustomBindings ??= new List<DataObjects.CustomBindingDefinition>();

        setting.CustomBindings.Add(new DataObjects.CustomBindingDefinition {
            Protocol = "https",
            Hostname = setting.WebsiteName?.Trim() ?? string.Empty,
            Port = DefaultPortForProtocol("https"),
            IpAddress = "*",
            Path = NormalizeBindingPath(setting.VirtualPath),
            SniFlag = true
        });

        NormalizeBindingsInPlace(setting);
        StateHasChanged();
    }

    private void RemoveCustomBinding(GlobalSettings.EnvironmentType envKey, int index)
    {
        if(!EnvSettings.TryGetValue(envKey, out var setting)) {
            return;
        }

        if(setting.CustomBindings != null && index >= 0 && index < setting.CustomBindings.Count) {
            setting.CustomBindings.RemoveAt(index);
            NormalizeBindingsInPlace(setting);
            StateHasChanged();
        }
    }

    private void BindingProtocolChanged(GlobalSettings.EnvironmentType envKey, int index, ChangeEventArgs e)
    {
        if(!EnvSettings.TryGetValue(envKey, out var setting)) {
            return;
        }

        var binding = GetBinding(setting, index);
        if(binding == null) {
            return;
        }

        var previousProtocol = binding.Protocol;
        binding.Protocol = NormalizeProtocol(e?.Value?.ToString());

        if(string.IsNullOrWhiteSpace(binding.Port) || binding.Port == DefaultPortForProtocol(previousProtocol)) {
            binding.Port = DefaultPortForProtocol(binding.Protocol);
        }

        binding.SniFlag = binding.Protocol == "https" ? true : null;

        NormalizeBindingsInPlace(setting);
        StateHasChanged();
    }

    private void BindingHostnameChanged(GlobalSettings.EnvironmentType envKey, int index, ChangeEventArgs e)
    {
        if(!EnvSettings.TryGetValue(envKey, out var setting)) {
            return;
        }

        var binding = GetBinding(setting, index);
        if(binding == null) {
            return;
        }

        binding.Hostname = (e?.Value?.ToString() ?? string.Empty).Trim();
        NormalizeBindingsInPlace(setting);
        StateHasChanged();
    }

    private void BindingPortChanged(GlobalSettings.EnvironmentType envKey, int index, ChangeEventArgs e)
    {
        if(!EnvSettings.TryGetValue(envKey, out var setting)) {
            return;
        }

        var binding = GetBinding(setting, index);
        if(binding == null) {
            return;
        }

        var value = e?.Value?.ToString() ?? string.Empty;
        var digits = new string(value.Where(char.IsDigit).ToArray());
        binding.Port = string.IsNullOrWhiteSpace(digits) ? DefaultPortForProtocol(binding.Protocol) : digits;

        NormalizeBindingsInPlace(setting);
        StateHasChanged();
    }

    private void BindingPathChanged(GlobalSettings.EnvironmentType envKey, int index, ChangeEventArgs e)
    {
        if(!EnvSettings.TryGetValue(envKey, out var setting)) {
            return;
        }

        var binding = GetBinding(setting, index);
        if(binding == null) {
            return;
        }

        binding.Path = NormalizeBindingPath(e?.Value?.ToString());
        NormalizeBindingsInPlace(setting);
        StateHasChanged();
    }

    private void SyncBindingHostnames(DataObjects.EnvSetting setting, string previousHostname, string newHostname)
    {
        if(setting?.CustomBindings == null) {
            return;
        }

        var previous = previousHostname?.Trim() ?? string.Empty;
        var updated = newHostname?.Trim() ?? string.Empty;

        foreach(var binding in setting.CustomBindings) {
            if(binding == null) {
                continue;
            }

            if(string.IsNullOrWhiteSpace(binding.Hostname) && !string.IsNullOrWhiteSpace(updated)) {
                binding.Hostname = updated;
            } else if(!string.IsNullOrWhiteSpace(previous) && string.Equals(binding.Hostname, previous, StringComparison.OrdinalIgnoreCase)) {
                binding.Hostname = updated;
            }
        }
    }

    private void SyncBindingPaths(DataObjects.EnvSetting setting, string previousPath, string newPath)
    {
        if(setting?.CustomBindings == null) {
            return;
        }

        var previous = NormalizeBindingPath(previousPath);
        var updated = NormalizeBindingPath(newPath);

        foreach(var binding in setting.CustomBindings) {
            if(binding == null) {
                continue;
            }

            if(string.IsNullOrWhiteSpace(binding.Path) && !string.IsNullOrWhiteSpace(updated)) {
                binding.Path = updated;
            } else if(!string.IsNullOrWhiteSpace(previous) && string.Equals(binding.Path ?? string.Empty, previous, StringComparison.OrdinalIgnoreCase)) {
                binding.Path = updated;
            }
        }
    }

}
